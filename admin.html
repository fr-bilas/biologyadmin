<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EduPlay — Admin Panel</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    /* তোমার আগের CSS একই রাখা হয়েছে */
    :root{--bg:#0b1020;--card:#0f1724;--muted:#94a3b8;--accent:#2563eb;--danger:#ef4444;--success:#10b981}
    *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial}
    body{margin:0;background:linear-gradient(180deg,#071023 0%, #071324 100%);color:#e6eef8}
    .wrap{max-width:1200px;margin:24px auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{font-size:20px;margin:0;display:flex;gap:10px;align-items:center}
    .nav-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:8px 12px;border-radius:8px;cursor:pointer;transition:all .2s}
    .nav-btn:hover{color:#fff;border-color:var(--accent)}
    .nav-btn.active{background:linear-gradient(90deg,var(--accent),#7c3aed);color:white;border:none;box-shadow:0 6px 20px rgba(37,99,235,0.12)}
    .grid{display:grid;grid-template-columns:260px 1fr;gap:16px}
    .panel{background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border:1px solid rgba(255,255,255,0.03);padding:14px;border-radius:10px}
    .small{font-size:13px;color:var(--muted)}
    .btn{background:var(--accent);border:none;color:white;padding:6px 12px;border-radius:8px;cursor:pointer;font-size:13px;transition:.2s}
    .btn:hover{opacity:.9}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .btn.danger{background:var(--danger)}
    .list{max-height:500px;overflow:auto}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;text-align:left;border-bottom:1px dashed rgba(255,255,255,0.06);font-size:13px}
    .pill{display:inline-block;padding:3px 8px;border-radius:999px;font-weight:600;font-size:12px}
    .pill.pending{background:rgba(255,255,255,0.05);color:var(--muted)}
    .pill.approved{background:rgba(16,185,129,0.12);color:var(--success)}
    .resource{padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.7);display:none;align-items:center;justify-content:center;z-index:999}
    .modal{background:var(--card);padding:16px;border-radius:10px;max-width:640px;width:94%}
    footer{margin-top:12px;color:var(--muted);font-size:13px;text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1><i class="fas fa-cog"></i> Admin Panel — EduPlay</h1>
    </header>

    <div class="grid">
      <aside class="panel">
        <button class="nav-btn active" data-section="users">Users</button>
        <button class="nav-btn" data-section="chapters">Chapters</button>
        <button class="nav-btn" data-section="media">Videos</button>
        <button class="nav-btn" data-section="live">Live Classes</button>
        <button class="nav-btn" data-section="routine">Routines</button>
      </aside>

      <main>
        <section id="users" class="panel section">
          <h3>Users</h3>
          <div style="margin:8px 0"><input id="userSearch" placeholder="Search user" style="width:200px;padding:6px;border-radius:6px"/> <button id="refreshUsers" class="btn ghost">Refresh</button></div>
          <div class="list" id="usersList"></div>
        </section>

        <section id="chapters" class="panel section" style="display:none">
          <h3>Chapters</h3>
          <input id="chapterName" placeholder="New chapter" /> <button id="addChapter" class="btn">Add</button>
          <div id="chaptersList" style="margin-top:10px"></div>
        </section>

        <section id="media" class="panel section" style="display:none">
          <h3>Videos</h3>
          <select id="mediaChapter"></select> <input id="videoTitle" placeholder="Title"/> <input id="videoLink" placeholder="YouTube link"/> <button id="addVideo" class="btn">Add Video</button>
          <div id="mediaList" style="margin-top:10px"></div>
        </section>

        <section id="live" class="panel section" style="display:none">
          <h3>Live Classes</h3>
          <input id="liveTitle" placeholder="Title"/> <input id="liveTime" placeholder="Time"/> <input id="liveZoom" placeholder="Zoom link"/> <button id="addLive" class="btn">Add</button>
          <div id="liveList" style="margin-top:10px"></div>
        </section>

        <section id="routine" class="panel section" style="display:none">
          <h3>Routines</h3>
          <input id="routineDay" placeholder="Day"/> <input id="routineTime" placeholder="Time"/> <input id="routineSubject" placeholder="Subject"/> <button id="addRoutine" class="btn">Add</button>
          <div id="routineList" style="margin-top:10px"></div>
        </section>

        <footer>Connected with Firebase Firestore & Functions</footer>
      </main>
    </div>
  </div>

  <div id="modal" class="modal-backdrop"><div class="modal"><div id="modalContent"></div><button id="modalClose" class="btn ghost">Close</button></div></div>

  <!-- Firebase Integration -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, where } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-functions.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDwIuLPaDRwMf8E2LdOkzcSUrdxOuSGkPw",
      authDomain: "biology-64aef.firebaseapp.com",
      projectId: "biology-64aef",
      storageBucket: "biology-64aef.firebasestorage.app",
      messagingSenderId: "473297240489",
      appId: "1:473297240489:web:f3d4d1d296a70a517b04b8",
      measurementId: "G-9XJ6340K12"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const functions = getFunctions(app);

    // Navigation
    function switchSection(id){
      document.querySelectorAll('.section').forEach(s=>s.style.display='none');
      document.getElementById(id).style.display='block';
      document.querySelectorAll('.nav-btn[data-section]').forEach(b=>b.classList.remove('active'));
      document.querySelector(`.nav-btn[data-section="${id}"]`).classList.add('active');
    }
    document.querySelectorAll('.nav-btn[data-section]').forEach(b=>b.onclick=()=>switchSection(b.dataset.section));

    /******** USERS ********/
    async function loadUsers(filter=''){
      const q = collection(db,'users');
      const snap = await getDocs(q);
      let html='<table><tr><th>Name</th><th>Login</th><th>Status</th><th>Actions</th></tr>';
      snap.forEach(d=>{
        const u=d.data();
        if(filter && !((u.email||u.phone||'').toLowerCase().includes(filter))) return;
        html+=`<tr>
          <td>${u.name||'-'}</td>
          <td>${u.email||u.phone||'-'}</td>
          <td><span class="pill ${u.approved?'approved':'pending'}">${u.approved?'approved':'pending'}</span></td>
          <td>
            <button class="btn" onclick="approveUser('${d.id}',${!u.approved})">${u.approved?'Revoke':'Approve'}</button>
            <button class="btn danger" onclick="deleteUser('${d.id}')">Delete</button>
          </td>
        </tr>`;
      });
      document.getElementById('usersList').innerHTML=html+'</table>';
    }

    window.approveUser=async(uid,approve)=>{
      const fn=httpsCallable(functions,'approveUser');
      await fn({uid,approve});
      loadUsers();
    };
    window.deleteUser=async(uid)=>{
      if(!confirm('Delete user?')) return;
      const fn=httpsCallable(functions,'deleteUserAndData');
      await fn({uid});
      loadUsers();
    };
    document.getElementById('refreshUsers').onclick=()=>loadUsers();
    document.getElementById('userSearch').oninput=e=>loadUsers(e.target.value.toLowerCase());

    /******** CHAPTERS ********/
    async function renderChapters(){
      const snap=await getDocs(collection(db,'chapters'));
      let html='';
      snap.forEach(d=>{
        const c=d.data();
        html+=`<div class="resource">${c.title}
          <div>
            <button class="btn ghost" onclick="editChapter('${d.id}','${c.title}')">Edit</button>
            <button class="btn danger" onclick="delChapter('${d.id}')">Del</button>
          </div></div>`;
      });
      document.getElementById('chaptersList').innerHTML=html;
      populateChapterSelect();
    }
    window.editChapter=async(id,old)=>{
      const n=prompt('Edit chapter',old);
      if(n){await updateDoc(doc(db,'chapters',id),{title:n});renderChapters();}
    }
    window.delChapter=async(id)=>{if(confirm('Delete?')){await deleteDoc(doc(db,'chapters',id));renderChapters();}}
    document.getElementById('addChapter').onclick=async()=>{
      const n=document.getElementById('chapterName').value;
      if(n){await addDoc(collection(db,'chapters'),{title:n});document.getElementById('chapterName').value='';renderChapters();}
    };

    /******** VIDEOS ********/
    async function populateChapterSelect(){
      const s=document.getElementById('mediaChapter');s.innerHTML='';
      const snap=await getDocs(collection(db,'chapters'));
      snap.forEach(d=>{s.innerHTML+=`<option value="${d.id}">${d.data().title}</option>`;});
      renderMedia();
    }
    async function renderMedia(){
      const snap=await getDocs(collection(db,'videos'));
      let html='';
      snap.forEach(d=>{
        const v=d.data();
        html+=`<div class="resource"><div><strong>${v.title}</strong></div>
        <div><button class="btn danger" onclick="delVideo('${d.id}')">Del</button></div></div>`;
      });
      document.getElementById('mediaList').innerHTML=html;
    }
    document.getElementById('addVideo').onclick=async()=>{
      const t=document.getElementById('videoTitle').value,l=document.getElementById('videoLink').value,c=document.getElementById('mediaChapter').value;
      if(t&&l&&c){await addDoc(collection(db,'videos'),{title:t,youtubeLink:l,chapterId:c});renderMedia();}
    }
    window.delVideo=async(id)=>{if(confirm('Delete video?')){await deleteDoc(doc(db,'videos',id));renderMedia();}}

    /******** LIVE CLASSES ********/
    async function renderLive(){
      const snap=await getDocs(collection(db,'liveClasses'));
      let html='';
      snap.forEach(d=>{
        const l=d.data();
        html+=`<div class="resource"><div><strong>${l.title}</strong> <span class="small">${l.time||''}</span></div>
        <div><button class="btn danger" onclick="delLive('${d.id}')">Del</button></div></div>`;
      });
      document.getElementById('liveList').innerHTML=html;
    }
    document.getElementById('addLive').onclick=async()=>{
      const t=document.getElementById('liveTitle').value,tm=document.getElementById('liveTime').value,z=document.getElementById('liveZoom').value;
      if(t&&z){await addDoc(collection(db,'liveClasses'),{title:t,time:tm,zoomLink:z});renderLive();}
    }
    window.delLive=async(id)=>{if(confirm('Delete?')){await deleteDoc(doc(db,'liveClasses',id));renderLive();}}

    /******** ROUTINES ********/
    async function renderRoutine(){
      const snap=await getDocs(collection(db,'routines'));
      let html='';
      snap.forEach(d=>{
        const r=d.data();
        html+=`<div class="resource"><div><strong>${r.day}</strong> <span class="small">${r.time} - ${r.subject}</span></div>
        <div><button class="btn danger" onclick="delRoutine('${d.id}')">Del</button></div></div>`;
      });
      document.getElementById('routineList').innerHTML=html;
    }
    document.getElementById('addRoutine').onclick=async()=>{
      const d=document.getElementById('routineDay').value,t=document.getElementById('routineTime').value,s=document.getElementById('routineSubject').value;
      if(d&&t&&s){await addDoc(collection(db,'routines'),{day:d,time:t,subject:s});renderRoutine();}
    }
    window.delRoutine=async(id)=>{if(confirm('Delete?')){await deleteDoc(doc(db,'routines',id));renderRoutine();}}

    // INIT
    loadUsers();
    renderChapters();
    renderLive();
    renderRoutine();
  </script>
</body>
</html>
